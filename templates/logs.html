<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“œ æ“ä½œæ—¥å¿—</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    select, button { margin: 5px 10px 10px 0; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #aaa; padding: 6px 10px; text-align: center; font-size: 14px; }
    th { background-color: #f4f4f4; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .denied { background-color: #ffd6d6; }
    .success { background-color: #d6ffd6; }
    .error { background-color: #fff0c2; }
  </style>
</head>
<body>

<h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>

<div>
  <label>Persona:</label>
  <select id="personaSelect">
    <option value="">å…¨éƒ¨</option>
    <option value="å°†å†›">å°†å†›</option>
    <option value="å¸é“ƒ">å¸é“ƒ</option>
    <option value="Lockling é”çµ">Lockling é”çµ</option>
    <option value="å°åŠ©æ‰‹">å°åŠ©æ‰‹</option>
  </select>

  <label>Intent:</label>
  <select id="intentSelect">
    <option value="">å…¨éƒ¨</option>
    <option value="delete_persona">delete_persona</option>
    <option value="authorize">authorize</option>
    <option value="revoke">revoke</option>
  </select>

  <label>Allow:</label>
  <select id="allowSelect">
    <option value="">å…¨éƒ¨</option>
    <option value="true">å…è®¸</option>
    <option value="false">æ‹’ç»</option>
  </select>

  <label>æ¯é¡µ:</label>
  <select id="limitSelect">
    <option value="10">10</option>
    <option value="25" selected>25</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select>

  <button onclick="loadLogs(true)">ç­›é€‰</button>
  <button onclick="exportCSV()">ğŸ“¥ å¯¼å‡º CSV</button>
</div>

<table id="logTable">
  <thead>
    <tr>
      <th>Persona</th><th>Message</th><th>Intent</th><th>Target</th>
      <th>Allow</th><th>Reason</th><th>Reply</th><th>Source</th><th>Time</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div style="margin-top:10px;">
  <button onclick="prevPage()">ä¸Šä¸€é¡µ</button>
  <span id="pageInfo">ç¬¬ 1 é¡µ</span>
  <button onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
</div>

<script>
  let currentPage = 1;
  let currentLogs = [];

  async function loadLogs(resetPage = false) {
    if (resetPage) currentPage = 1;

    const persona = document.getElementById('personaSelect').value;
    const intent = document.getElementById('intentSelect').value;
    const allow = document.getElementById('allowSelect').value;
    const limit = parseInt(document.getElementById('limitSelect').value);
    const offset = (currentPage - 1) * limit;

    const response = await fetch('/log/query', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        persona: persona || null,
        intent_type: intent || null,
        allow: allow === "" ? null : (allow === "true"),
        limit: limit,
        offset: offset
      })
    });

    const data = await response.json();
    const logs = data.logs || [];
    currentLogs = logs;

    const tbody = document.querySelector('#logTable tbody');
    tbody.innerHTML = "";

    logs.forEach(log => {
      const row = document.createElement('tr');
      row.className = log.allow === false ? 'denied' : (log.allow === true ? 'success' : 'error');
      row.innerHTML = `
        <td>${log.persona || ''}</td>
        <td>${log.message || ''}</td>
        <td>${log.intent_type || ''}</td>
        <td>${log.target || ''}</td>
        <td>${log.allow}</td>
        <td>${log.reason || ''}</td>
        <td>${log.reply || ''}</td>
        <td>${log.source || ''}</td>
        <td>${log.time || ''}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById('pageInfo').innerText = `ç¬¬ ${currentPage} é¡µ`;
  }

  function nextPage() {
    currentPage += 1;
    loadLogs();
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage -= 1;
      loadLogs();
    }
  }

  function exportCSV() {
    if (!currentLogs.length) return alert("æ— æ•°æ®å¯å¯¼å‡º");
    const rows = [
      ["Persona", "Message", "Intent", "Target", "Allow", "Reason", "Reply", "Source", "Time"],
      ...currentLogs.map(log => [
        log.persona || '',
        log.message || '',
        log.intent_type || '',
        log.target || '',
        log.allow,
        log.reason || '',
        log.reply || '',
        log.source || '',
        log.time || ''
      ])
    ];
    const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const now = new Date();
    const filename = `logs_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_${now.getHours()}-${now.getMinutes()}.csv`;

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  // âœ… ä¿®å¤ï¼šåˆ‡æ¢æ¯é¡µæ˜¾ç¤ºæ—¶ç«‹å³åˆ·æ–°
  document.getElementById("limitSelect").addEventListener("change", function () {
    loadLogs(true);
  });

  // åˆå§‹åŠ è½½
  loadLogs();
</script>

</body>
</html>
