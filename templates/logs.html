<!DOCTYPE html>
<html lang="zh">
<head>
  <style>
  summary:hover { color: #007acc; }
  .json-viewer { 
    font-family: monospace; 
    background: #f4f4f4; 
    padding: 8px; 
    border-radius: 4px; 
  }
  </style>
  <meta charset="UTF-8">
  <title>ğŸ“œ Lockling äº‘è„‘ æ“ä½œæ—¥å¿—</title>
  <style>
    body {
      font-family: "Inter", "Noto Sans SC", sans-serif;
      padding: 30px;
      background-color: #f5f6f7;
      color: #333;
    }
    h2 {
      margin-bottom: 10px;
    }
    .controls {
      margin-bottom: 10px;
    }
    input {
      padding: 6px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f0f2f5;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .success { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    .pending { color: gray; }
    pre {
      white-space: pre-wrap;
      font-size: 13px;
      margin: 0;
    }
    .footer {
      text-align: center;
      color: #999;
      font-size: 12px;
      margin-top: 40px;
    }
    .toggle-btn {
      color: #007bff;
      cursor: pointer;
      font-size: 12px;
      margin-top: 5px;
      display: inline-block;
    }
    .stats {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h2>ğŸ“œ Lockling äº‘è„‘ æ“ä½œæ—¥å¿—</h2>

<div class="controls">
  ğŸ” <input type="text" id="searchInput" placeholder="æœç´¢ Persona / Intent">
  <button onclick="loadLogs()">ğŸ”„ æ‰‹åŠ¨åˆ·æ–°</button>
  <button onclick="exportLogs()">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
  <a href="/dashboard/personas" style="margin-left: 10px; font-size: 13px;">â†© è¿”å›ä»ªè¡¨ç›˜</a>
</div>

<div class="stats" id="stats">æ—¥å¿—ç»Ÿè®¡ï¼šåŠ è½½ä¸­...</div>

<table>
  <thead>
    <tr>
      <th>Persona</th>
      <th>Intent</th>
      <th>Status</th>
      <th>Detail</th>
      <th>Time</th>
    </tr>
  </thead>
  <tbody id="logBody">
    <tr><td colspan="5">â³ åŠ è½½ä¸­...</td></tr>
  </tbody>
</table>

<div class="footer">ğŸª¶ ç”± Lockling å®ˆæŠ¤ Â· æ•°æ®æ¥æºäº‘è„‘ç³»ç»Ÿ</div>

<script>
function parseJSONSmart(input) {
  try {
    let result = input;
    let depth = 0;
    while (typeof result === "string" && depth < 5) {
      result = JSON.parse(result);
      depth++;
    }
    return typeof result === "object" ? JSON.stringify(result, null, 2) : result;
  } catch (e) {
    return typeof input === "object" ? JSON.stringify(input, null, 2) : input;
  }
}

function createCollapsibleDetail(content) {
  const short = content.slice(0, 100);
  const full = content;
  const container = document.createElement("div");
  const pre = document.createElement("pre");
  const toggle = document.createElement("span");
  let expanded = false;

  pre.textContent = short + "...";
  toggle.textContent = "å±•å¼€ â–¼";
  toggle.className = "toggle-btn";

  toggle.onclick = () => {
    expanded = !expanded;
    pre.textContent = expanded ? full : short + "...";
    toggle.textContent = expanded ? "æ”¶èµ· â–²" : "å±•å¼€ â–¼";
  };

  container.appendChild(pre);
  container.appendChild(toggle);
  return container;
}

async function loadLogs() {
  const tbody = document.getElementById("logBody");
  const statsDiv = document.getElementById("stats");
  const search = document.getElementById("searchInput").value.toLowerCase();

  tbody.innerHTML = "<tr><td colspan='5'>â³ åŠ è½½ä¸­...</td></tr>";
  try {
    const res = await fetch("/log/query", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const data = await res.json();
    const logs = data.logs || [];
    cachedLogs = logs;    

    // ç»Ÿè®¡ä¿¡æ¯
    const total = logs.length;
    const success = logs.filter(l => l.status === "success").length;
    const fail = logs.filter(l => l.status === "fail").length;
    const pending = logs.filter(l => !l.status || l.status === "pending").length;
    statsDiv.textContent = `æ—¥å¿—ç»Ÿè®¡ï¼šå…± ${total} æ¡ Â· âœ… æˆåŠŸ ${success} æ¡ Â· âŒ å¤±è´¥ ${fail} æ¡ Â· â³ ç­‰å¾… ${pending} æ¡`;

    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = "";
    logs.forEach(log => {
      const persona = (log.persona || 'â€”').toLowerCase();
      const intent = (log.intent_type || 'â€”').toLowerCase();
      if (search && !persona.includes(search) && !intent.includes(search)) return;

      const status = log.status || (log.allow === true ? "success" : (log.allow === false ? "fail" : "pending"));
      const statusClass = status === "success" ? "success" : status === "fail" ? "fail" : "pending";
      const time = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'â€”';
      const detailRaw = log.intent_result || log.reply || log.raw_intent || 'â€”';
      const detailParsed = parseJSONSmart(detailRaw);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>
          <details>
            <summary style="cursor: pointer; font-weight: bold;">æŸ¥çœ‹è¯¦æƒ…</summary>
            <pre class="json-viewer" style="white-space: pre-wrap;">${detailParsed}</pre>
          </details>
        </td>
        <td>${log.intent_type || 'â€”'}</td>
        <td class="${statusClass}">${status === "success" ? "âœ… success" : (status === "fail" ? "âŒ fail" : "â³ pending")}</td>
        <td></td>
        <td>${time}</td>
      `;

      const detailCell = row.children[3];
      detailCell.appendChild(createCollapsibleDetail(detailParsed));

      tbody.appendChild(row);
    });

  } catch (error) {
    console.error("ğŸš¨ åŠ è½½å¤±è´¥:", error);
    tbody.innerHTML = "<tr><td colspan='5'>âŒ æ—¥å¿—åŠ è½½å¤±è´¥</td></tr>";
  }
}

loadLogs();
setInterval(loadLogs, 30000); // è‡ªåŠ¨åˆ·æ–°é—´éš” 30 ç§’
</script>

</body>
</html>
