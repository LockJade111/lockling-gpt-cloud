<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</title>
  <style>
    body { font-family: sans-serif; padding: 30px; background-color: #f8f9fa; }
    h2, h3 { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #eee; }
    button {
      padding: 5px 10px; border: none; border-radius: 4px;
      background-color: #007bff; color: white; cursor: pointer; margin-right: 5px;
    }
    button:hover { background-color: #0056b3; }
    .danger { background-color: #dc3545; }
    .danger:hover { background-color: #c82333; }
    .hidden { display: none; }
    input[type="text"], input[type="password"] {
      padding: 5px; margin: 5px; width: 200px;
    }
  </style>
</head>
<body>

<h2>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</h2>

<!-- æœç´¢ -->
<input type="text" id="searchInput" placeholder="ğŸ” è¾“å…¥å…³é”®è¯è¿‡æ»¤è§’è‰²..." oninput="filterTable()"/>

<!-- è§’è‰²åˆ—è¡¨ -->
<table id="personaTable">
  <thead>
    <tr>
      <th>è§’è‰²å</th>
      <th>æƒé™åˆ—è¡¨</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="personaList"></tbody>
</table>

<!-- åˆ†é¡µæ§ä»¶ -->
<div style="margin-top: 10px;">
  <button onclick="prevPage()">ä¸Šä¸€é¡µ</button>
  <span id="pageIndicator">ç¬¬ 1 é¡µ</span>
  <button onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
</div>

<!-- æ³¨å†Œ -->
<h3>ğŸ†• æ³¨å†Œæ–°è§’è‰²</h3>
<form id="registerForm">
  <input type="text" id="newPersona" placeholder="è§’è‰²åï¼ˆæ”¯æŒä¸­æ–‡ï¼‰" required>
  <input type="password" id="newSecret" placeholder="å¯†é’¥" required>
  <input type="checkbox" id="showSecret" onchange="toggleSecret()"> æ˜¾ç¤ºå¯†é’¥
  <br><br>
  <button type="submit">æ³¨å†Œ</button>
</form>

<!-- æƒé™ç¼–è¾‘å¼¹çª— -->
<div id="editModal" class="hidden" style="position: fixed; top: 20%; left: 30%; width: 40%; padding: 20px; background: white; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 999;">
  <h3>ç¼–è¾‘æƒé™ - <span id="editPersonaName"></span></h3>
  <div id="permissionOptions"></div>
  <br>
  <button onclick="savePermissions()">ä¿å­˜</button>
  <button class="danger" onclick="closeModal()">å–æ¶ˆ</button>
</div>

<script>
const availablePermissions = ["read", "write", "admin", "query", "report", "budget"];
let currentEditing = "";
let personas = [];
let currentPage = 1;
const itemsPerPage = 5;

function toggleSecret() {
  const input = document.getElementById("newSecret");
  input.type = document.getElementById("showSecret").checked ? "text" : "password";
}

function openModal(role, permissions) {
  currentEditing = role;
  document.getElementById("editPersonaName").innerText = role;
  const container = document.getElementById("permissionOptions");
  container.innerHTML = "";
  availablePermissions.forEach(p => {
    const checked = permissions.includes(p) ? "checked" : "";
    container.innerHTML += `<label><input type="checkbox" value="${p}" ${checked}> ${p}</label><br>`;
  });
  document.getElementById("editModal").classList.remove("hidden");
}

function closeModal() {
  document.getElementById("editModal").classList.add("hidden");
  currentEditing = "";
}

async function loadPersonas() {
  const res = await fetch("/persona/details");
  const data = await res.json();
  personas = data.data || [];
  renderTable();
}

function renderTable() {
  const table = document.getElementById("personaList");
  table.innerHTML = "";
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const filtered = filterPersonas();
  const pageItems = filtered.slice(start, end);

  pageItems.forEach(p => {
    const perms = Array.isArray(p.permissions) ? p.permissions : [];
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${p.role}</td>
      <td>${perms.join(", ")}</td>
      <td>
        <button onclick="openModal('${p.role}', ${JSON.stringify(perms)})">ç¼–è¾‘</button>
        <button class="danger" onclick="deletePersona('${p.role}')">åˆ é™¤</button>
      </td>
    `;
    table.appendChild(row);
  });

  document.getElementById("pageIndicator").innerText = `ç¬¬ ${currentPage} é¡µ`;
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
}

function nextPage() {
  const totalPages = Math.ceil(filterPersonas().length / itemsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderTable();
  }
}

function filterPersonas() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  return personas.filter(p => p.role.toLowerCase().includes(keyword));
}

async function savePermissions() {
  const checkboxes = document.querySelectorAll("#permissionOptions input[type='checkbox']");
  const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

  const res = await fetch("/persona/update_permissions", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      role: currentEditing,
      permissions: selected
    })
  });

  const data = await res.json();
  if (data.status === "success") {
    alert("âœ… æƒé™å·²æ›´æ–°");
    closeModal();
    loadPersonas();
  } else {
    alert("âŒ æ›´æ–°å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
  }
}

async function deletePersona(role) {
  const secret = prompt(`è¯·è¾“å…¥å¯†é’¥ä»¥åˆ é™¤è§’è‰²ã€Œ${role}ã€ï¼š`);
  if (!secret) return;

  const res = await fetch("/persona/delete", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ persona: role, secret })
  });

  const data = await res.json();
  if (data.result) {
    alert("âœ… åˆ é™¤æˆåŠŸ");
    loadPersonas();
  } else {
    alert("âŒ åˆ é™¤å¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯"));
  }
}

document.getElementById("registerForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const name = document.getElementById("newPersona").value.trim();
  const secret = document.getElementById("newSecret").value.trim();

  const res = await fetch("/persona/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ persona: name, secret, operator: "å°†å†›" })
  });

  const data = await res.json();
  if (data.success) {
    alert("âœ… æ³¨å†ŒæˆåŠŸ");
    loadPersonas();
    document.getElementById("registerForm").reset();
  } else {
    alert("âŒ æ³¨å†Œå¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯"));
  }
});

loadPersonas();
</script>
</body>
</html>
