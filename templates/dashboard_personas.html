<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</title>
  <style>
    body { font-family: sans-serif; padding: 30px; background-color: #f8f9fa; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #eee; }
    button {
      padding: 5px 10px; border: none; border-radius: 4px;
      background-color: #007bff; color: white; cursor: pointer; margin-right: 5px;
    }
    button:hover { background-color: #0056b3; }
    .danger { background-color: #dc3545; }
    .danger:hover { background-color: #c82333; }
    input[type="text"], input[type="password"] {
      padding: 5px; margin: 5px; width: 200px;
    }
  </style>
</head>
<body>

<h2>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</h2>

<!-- ğŸ” æœç´¢ -->
<input type="text" id="searchInput" placeholder="ğŸ” è¾“å…¥å…³é”®è¯è¿‡æ»¤è§’è‰²..." oninput="filterTable()" />

<!-- ğŸ“‹ è§’è‰²åˆ—è¡¨ -->
<table id="personaTable">
  <thead>
    <tr>
      <th>è§’è‰²å</th>
      <th>æƒé™è¯´æ˜</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="personaList">
    <tr><td colspan="3">æ­£åœ¨åŠ è½½è§’è‰²...</td></tr>
  </tbody>
</table>

<!-- â• æ³¨å†Œæ–°è§’è‰² -->
<h3>ğŸ†• æ³¨å†Œæ–°è§’è‰²</h3>
<form id="registerForm" onsubmit="registerPersona(event)">
  <div>
    <label>è§’è‰²IDï¼ˆpersonaï¼‰ï¼š</label>
    <input type="text" id="persona" name="persona" required />
  </div>
  <div>
    <label>æ˜¾ç¤ºåï¼ˆnameï¼‰ï¼š</label>
    <input type="text" id="name" name="name" required />
  </div>
  <div>
    <label>å¯†é’¥ï¼ˆsecretï¼‰ï¼š</label>
    <input type="password" id="secret" name="secret" required />
    <button type="button" onclick="toggleSecret()">ğŸ‘ï¸</button>
    <br /><small style="color: #666;">æ”¯æŒä¸­æ–‡å¯†é’¥ï¼Œå»ºè®®å¦¥å–„ä¿ç®¡</small>
  </div>
  <div>
    <label>ç®€ä»‹ï¼ˆintroï¼‰ï¼š</label>
    <input type="text" id="intro" name="intro" />
  </div>
  <div>
    <label>æˆæƒç»™ï¼ˆauthorizeï¼Œå¯ç•™ç©ºï¼‰ï¼š</label>
    <input type="text" id="authorize" name="authorize" />
  </div>
  <div>
    <button type="submit">ğŸ“ æäº¤æ³¨å†Œ</button>
  </div>
</form>

<script>
  function toggleSecret() {
    const input = document.getElementById("secret");
    input.type = input.type === "password" ? "text" : "password";
  }

  function registerPersona(event) {
    event.preventDefault();
    const form = document.getElementById("registerForm");
    const formData = new FormData(form);

    fetch("/persona/register", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        alert("âœ… æ³¨å†ŒæˆåŠŸ");
        form.reset();
        loadPersonas();
      } else {
        alert("âŒ æ³¨å†Œå¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
      }
    })
    .catch(err => {
      alert("ç½‘ç»œé”™è¯¯ï¼š" + err.message);
    });
  }

  function deletePersona(persona) {
    const secret = prompt("è¯·è¾“å…¥æƒé™å¯†é’¥ä»¥åˆ é™¤è§’è‰²ï¼š" + persona);
    if (!secret) return;

    const payload = { persona, operator: persona, secret };
    fetch("/persona/delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "æ“ä½œå®Œæˆ");
      if (data.success) loadPersonas();
    });
  }

  function loadPersonas() {
    const tbody = document.getElementById("personaList");
    tbody.innerHTML = "<tr><td colspan='3'>â³ åŠ è½½ä¸­...</td></tr>";

    fetch("/logs")
      .then(res => res.json())
      .then(res => {
        const logs = res.data || [];
        const personas = [...new Set(
          logs.map(log => {
            try {
              const intent = typeof log.intent_result === "string"
                ? JSON.parse(log.intent_result)
                : log.intent_result || {};
              return intent.persona || null;
            } catch (e) {
              return null;
            }
          }).filter(Boolean)
        )];

        if (personas.length === 0) {
          tbody.innerHTML = "<tr><td colspan='3'>âš ï¸ å½“å‰æš‚æ— è§’è‰²ï¼Œè¯·æ³¨å†Œã€‚</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        personas.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td>${p}</td>
              <td>â€”</td>
              <td>
                <button class="danger" onclick="deletePersona('${p}')">åˆ é™¤</button>
              </td>
            </tr>`;
        });
      })
      .catch(err => {
        tbody.innerHTML = "<tr><td colspan='3'>âŒ åŠ è½½å¤±è´¥ï¼š" + err.message + "</td></tr>";
      });
  }

  function filterTable() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#personaTable tbody tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(keyword) ? "" : "none";
    });
  }

  window.onload = loadPersonas;
</script>

</body>
</html>
