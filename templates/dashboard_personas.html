<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è§’è‰²ç®¡ç† Â· Lockling äº‘è„‘</title>
  <style>
    body { font-family: sans-serif; padding: 30px; background-color: #f8f9fa; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #eee; }
    button { padding: 5px 10px; margin: 5px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .danger { background-color: #dc3545; }
    .danger:hover { background-color: #c82333; }
    .pagination { margin-top: 20px; text-align: center; }
  </style>
</head>
<body>
  <h2>ğŸ§‘â€ğŸ’¼ Persona æƒé™ç®¡ç†</h2>

  <table>
    <thead>
      <tr>
        <th>è§’è‰²å</th>
        <th>æƒé™åˆ—è¡¨</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="personaList"></tbody>
  </table>

  <div class="pagination">
    <button onclick="prevPage()">â¬… ä¸Šä¸€é¡µ</button>
    <span id="pageInfo">ç¬¬ 1 é¡µ</span>
    <button onclick="nextPage()">ä¸‹ä¸€é¡µ â¡</button>
  </div>

  <h3>â• æ³¨å†Œæ–°è§’è‰²</h3>
  <form id="registerForm">
    <input type="text" id="newPersona" placeholder="è§’è‰²å" required>
    <input type="password" id="newSecret" placeholder="å¯†é’¥" required>
    <input type="checkbox" id="showSecret" onchange="toggleSecret()"> æ˜¾ç¤ºå¯†é’¥
    <br><br>
    <button type="submit">æ³¨å†Œ</button>
  </form>

  <!-- ç¼–è¾‘æƒé™å¼¹çª— -->
  <div id="editModal" style="display:none;position:fixed;top:20%;left:30%;width:40%;padding:20px;background:#fff;border:1px solid #ccc;box-shadow:0 0 10px rgba(0,0,0,0.3);z-index:999;">
    <h3>ç¼–è¾‘æƒé™ - <span id="editPersonaName"></span></h3>
    <div id="permissionOptions"></div>
    <br>
    <button onclick="savePermissions()">ä¿å­˜</button>
    <button class="danger" onclick="closeModal()">å–æ¶ˆ</button>
  </div>

<script>
  const availablePermissions = ["read", "write", "admin", "query", "report", "budget", "åˆ›å»ºæ–°è§’è‰²", "åˆ é™¤è§’è‰²"];
  let currentEditing = "";
  let currentPage = 1;
  const perPage = 5;

  function toggleSecret() {
    const input = document.getElementById("newSecret");
    input.type = document.getElementById("showSecret").checked ? "text" : "password";
  }

  async function loadPersonas(page = 1) {
    const response = await fetch(`/persona/details?page=${page}&per_page=${perPage}`);
    const data = await response.json();
    const table = document.getElementById("personaList");
    const pageInfo = document.getElementById("pageInfo");
    table.innerHTML = "";

    (data.data || []).forEach(p => {
      const perms = Array.isArray(p.permissions) ? p.permissions : [];
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.role}</td>
        <td>${perms.join(", ")}</td>
        <td><button onclick="openModal('${p.role}', ${JSON.stringify(perms)})">ç¼–è¾‘</button></td>
      `;
      table.appendChild(row);
    });

    pageInfo.innerText = `ç¬¬ ${page} é¡µ`;
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      loadPersonas(currentPage);
    }
  }

  function nextPage() {
    currentPage++;
    loadPersonas(currentPage);
  }

  function openModal(role, permissions) {
    currentEditing = role;
    document.getElementById("editPersonaName").innerText = role;
    const container = document.getElementById("permissionOptions");
    container.innerHTML = "";

    availablePermissions.forEach(p => {
      const checked = permissions.includes(p) ? "checked" : "";
      container.innerHTML += `<label><input type="checkbox" value="${p}" ${checked}> ${p}</label><br>`;
    });

    document.getElementById("editModal").style.display = "block";
  }

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
    currentEditing = "";
  }

  async function savePermissions() {
    const checkboxes = document.querySelectorAll("#permissionOptions input[type='checkbox']");
    const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

    const res = await fetch("/persona/update_permissions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ role: currentEditing, permissions: selected })
    });

    const data = await res.json();
    if (data.status === "success") {
      alert("âœ… æƒé™å·²æ›´æ–°");
      closeModal();
      loadPersonas(currentPage);
    } else {
      alert("âŒ æ›´æ–°å¤±è´¥ï¼š" + (data.message || "æœªçŸ¥é”™è¯¯"));
    }
  }

  document.getElementById("registerForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const name = document.getElementById("newPersona").value.trim();
    const secret = document.getElementById("newSecret").value.trim();

    const res = await fetch("/persona/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        persona: name,
        secret: secret,
        operator: "å°†å†›"
      })
    });

    const data = await res.json();
    if (data.success) {
      alert("âœ… æ³¨å†ŒæˆåŠŸ");
      loadPersonas(currentPage);
      document.getElementById("registerForm").reset();
    } else {
      alert("âŒ æ³¨å†Œå¤±è´¥ï¼š" + (data.error || "æœªçŸ¥é”™è¯¯"));
    }
  });

  loadPersonas(currentPage);
</script>
</body>
</html>
