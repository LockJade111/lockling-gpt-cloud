<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</title>
  <style>
    body { font-family: sans-serif; padding: 30px; background-color: #f8f9fa; }
    h2, h3 { margin-top: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
    th { background-color: #eee; }
    button {
      padding: 5px 10px; border: none; border-radius: 4px;
      background-color: #007bff; color: white; cursor: pointer; margin-right: 5px;
    }
    button:hover { background-color: #0056b3; }
    .danger { background-color: #dc3545; }
    .danger:hover { background-color: #c82333; }
    .hidden { display: none; }
    input[type="text"], input[type="password"] {
      padding: 5px; margin: 5px; width: 200px;
    }
  </style>
</head>
<body>

<h2>ğŸ” Persona è¶…æ™ºä½“ç®¡ç†</h2>

<!-- ğŸ” æœç´¢ -->
<input type="text" id="searchInput" placeholder="ğŸ” è¾“å…¥å…³é”®è¯è¿‡æ»¤è§’è‰²..." oninput="filterTable()"/>

<!-- ğŸ“‹ è§’è‰²åˆ—è¡¨ -->
<table id="personaTable">
  <thead>
    <tr>
      <th>è§’è‰²å</th>
      <th>æƒé™è¯´æ˜</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody id="personaList">
    <tr><td colspan="3">æ­£åœ¨åŠ è½½è§’è‰²...</td></tr>
  </tbody>
</table>

<!-- â• æ³¨å†Œæ–°è§’è‰² -->
<h3>ğŸ†• æ³¨å†Œæ–°è§’è‰²</h3>
<form id="registerForm" onsubmit="registerPersona(event)">
  <label>è§’è‰²åï¼ˆpersonaï¼‰ï¼š<input type="text" id="persona" /></label><br>
  <label>æ˜¾ç¤ºåï¼ˆnameï¼‰ï¼š<input type="text" id="name" /></label><br>
  <label>å¯†é’¥ï¼ˆsecretï¼‰ï¼š<input type="password" id="secret" /></label><br>
  <button type="submit">æäº¤æ³¨å†Œ</button>
</form>

<script>
  // âœ… æ³¨å†Œé€»è¾‘ï¼šä½¿ç”¨ FormData
  function registerPersona(event) {
    event.preventDefault();

    const formData = new FormData();
    formData.append("name", document.getElementById("name").value);
    formData.append("persona", document.getElementById("persona").value);
    formData.append("secret", document.getElementById("secret").value);

    fetch("/persona/register", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "æ³¨å†Œå®Œæˆ");
      if (data.status === "success") {
        loadPersonas(); // âœ… åˆ·æ–°è§’è‰²åˆ—è¡¨
      }
    })
    .catch(err => alert("è¯·æ±‚å¤±è´¥ï¼š" + err.message));
  }

  // âœ… åˆ é™¤è§’è‰²
  function deletePersona(persona) {
    const secret = prompt("è¯·è¾“å…¥æƒé™å¯†é’¥ä»¥åˆ é™¤è§’è‰²ï¼š" + persona);
    if (!secret) return;

    const formData = new FormData();
    formData.append("persona", persona);
    formData.append("secret", secret);

    fetch("/persona/delete", {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || "æ“ä½œå®Œæˆ");
      if (data.status === "success") {
        loadPersonas();
      }
    });
  }

  // âœ… åŠ è½½è§’è‰²åˆ—è¡¨
  function loadPersonas() {
    const tbody = document.getElementById("personaList");
    tbody.innerHTML = "<tr><td colspan='3'>â³ åŠ è½½ä¸­...</td></tr>";

    fetch("/logs")
      .then(res => res.json())
      .then(res => {
        const logs = res.data || [];
        const personas = [...new Set(logs.map(log => log.persona).filter(Boolean))];
        if (personas.length === 0) {
          tbody.innerHTML = "<tr><td colspan='3'>âš ï¸ å½“å‰æš‚æ— è§’è‰²ï¼Œè¯·æ³¨å†Œã€‚</td></tr>";
          return;
        }

        tbody.innerHTML = "";
        personas.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td>${p}</td>
              <td>â€”</td>
              <td>
                <button onclick="deletePersona('${p}')" class="danger">åˆ é™¤</button>
              </td>
            </tr>
          `;
        });
      })
      .catch(err => {
        tbody.innerHTML = "<tr><td colspan='3'>âŒ åŠ è½½å¤±è´¥ï¼š" + err.message + "</td></tr>";
      });
  }

  // âœ… æœç´¢è¿‡æ»¤è¡¨æ ¼
  function filterTable() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#personaTable tbody tr").forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(keyword) ? "" : "none";
    });
  }

  // âœ… é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  window.onload = loadPersonas;
</script>

</body>
</html>
